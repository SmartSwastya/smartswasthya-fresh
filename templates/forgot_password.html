{% extends "base.html" %}

{% block title %}Forgot Password - Smart Swasthya Seva{% endblock %}

{% block content %}
{% block js %}{{ js }}{% endblock %}
<div class="max-w-md mx-auto bg-white/50 backdrop-blur-md p-6 mt-16 rounded-2xl shadow-lg border border-cyan-100">
  <div class="flex justify-center mb-6">
    <img src="/static/images/logo.png" alt="Smart Swasthya Logo" class="w-24 h-24 rounded-full">
  </div>

  <h2 class="text-xl font-bold text-center mb-4">ğŸ” Forgot Password</h2>

  <form onsubmit="return false;" class="space-y-4">
    <div>
      <label class="block font-semibold mb-1">ğŸ“± Mobile Number</label>
      <input type="tel" id="mobile" class="input" placeholder="Enter your registered mobile" required>
    </div>

    <div class="flex justify-between items-center">
      <button type="button" id="sendBtn" onclick="sendOTP()" class="btn">ğŸ“¨ Send OTP</button>
      <span id="timer" class="text-sm text-gray-500"></span>
    </div>

    <div id="otpSection" class="hidden">
      <label class="block font-semibold mb-1">ğŸ”¢ Enter OTP</label>
      <input type="text" id="otpInput" class="input" maxlength="6" placeholder="Enter 6-digit OTP">
    </div>

    <div id="passwordSection" class="hidden">
      <label class="block font-semibold mb-1">ğŸ” New Password</label>
      <input type="password" id="passwordInput" class="input" placeholder="Enter new password">
    </div>

    <div id="submitSection" class="hidden">
      <button type="button" onclick="resetPassword()" class="btn w-full">âœ… Reset Password</button>
    </div>

    <p class="text-center text-sm text-gray-600 mt-2">
      Remembered your password? 
      <a href="/login" class="text-cyan-600 hover:underline">Go to Login</a>
    </p>
  </form>
</div>

<script>
  let countdown;

  function startTimer() {
    let seconds = 60;
    const timer = document.getElementById("timer");
    const btn = document.getElementById("sendBtn");
    btn.disabled = true;
    countdown = setInterval(() => {
      seconds--;
      timer.textContent = `â³ Resend in ${seconds}s`;
      if (seconds <= 0) {
        clearInterval(countdown);
        timer.textContent = "";
        btn.disabled = false;
        btn.innerText = "ğŸ” Resend OTP";
      }
    }, 1000);
  }

  async function sendOTP() {
    const mobile = document.getElementById("mobile").value.trim();
    if (!mobile || mobile.length !== 10) {
      return alert("âŒ Please enter a valid 10-digit mobile number");
    }

    const response = await fetch(`/send-forgot-otp?mobile=${mobile}`);
    const data = await response.json();

    if (data.status === "sent") {
      alert("âœ… OTP sent successfully!");
      document.getElementById("otpSection").classList.remove("hidden");
      document.getElementById("passwordSection").classList.remove("hidden");
      document.getElementById("submitSection").classList.remove("hidden");
      startTimer();
    } else {
      alert("âŒ " + (data.message || "Failed to send OTP"));
    }
  }

  async function resetPassword() {
    const mobile = document.getElementById("mobile").value.trim();
    const otp = document.getElementById("otpInput").value.trim();
    const password = document.getElementById("passwordInput").value.trim();

    if (!mobile || !otp || !password) {
      return alert("âŒ All fields are required!");
    }

    const response = await fetch(`/reset-password?mobile=${mobile}&otp=${otp}&password=${encodeURIComponent(password)}`);
    const data = await response.json();

    if (data.success) {
      alert("ğŸ‰ Password reset successful! Redirecting...");
      window.location.href = "/login";  // âœ… Awareness hata diya gaya
    } else {
      alert("âŒ " + (data.message || "Reset failed"));
    }
  }
</script>

<style>
  .input {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.3rem;
    margin-bottom: 1rem;
    border: 1px solid #ccc;
    border-radius: 0.375rem;
    transition: border-color 0.2s;
  }
  .input:focus {
    border-color: #38a1db;
    outline: none;
  }
  .btn {
    background: linear-gradient(to right, #4dc0b5, #38a1db);
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: bold;
    transition: all 0.3s;
  }
  .btn:hover {
    background: linear-gradient(to right, #38a1db, #4dc0b5);
  }
</style>
{% endblock %}
